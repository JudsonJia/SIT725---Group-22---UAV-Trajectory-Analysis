<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UAV Flight Analysis</title>
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { margin-top: 20px; }
        .actions button { margin-left: 5px; }
        .report-checkbox { margin-right: 10px; vertical-align: middle; }
    </style>
</head>
<body class="container">

<h4>Flight Analysis</h4>

<!-- Status display -->
<div id="status" class="card-panel grey lighten-3">‚è≥ Waiting...</div>

<!-- Start analysis button (only visible when flightId exists) -->
<button id="startBtn" class="btn waves-effect waves-light green" style="display:none;">
    <i class="material-icons left">play_arrow</i> Start Analysis
</button>

<!-- History reports -->
<div id="history" class="section" style="margin-top:20px;">
    <h5>History Reports</h5>

    <!-- Export PDF button -->
    <button id="exportPdfBtn" class="btn blue waves-effect waves-light" style="margin-bottom: 10px;">
        <i class="material-icons left">picture_as_pdf</i>Export Selected PDF
    </button>

    <ul id="report-list" class="collection"></ul>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
    const params = new URLSearchParams(location.search);
    const flightId = params.get('flightId');
    const token = localStorage.getItem('uav_token');

    const statusDiv = document.getElementById('status');
    const reportList = document.getElementById('report-list');
    const startBtn = document.getElementById('startBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');

    const socket = io();

    // Decode userId from JWT token
    function getUserIdFromToken() {
        if (!token) return null;
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.userId || null;
        } catch (e) {
            console.error("Failed to decode token:", e);
            return null;
        }
    }

    const userId = getUserIdFromToken();

    // Initialize page
    initAnalysisPage();

    function initAnalysisPage() {
        if (!userId) {
            statusDiv.className = "card-panel red lighten-4";
            statusDiv.textContent = "‚ùå Missing userId in token. Please re-login.";
            startBtn.style.display = "none";
        } else if (flightId && flightId !== "null") {
            statusDiv.className = "card-panel teal lighten-4";
            statusDiv.textContent = "‚úÖ Ready. Click start analysis in UI (socket).";
            startBtn.style.display = "inline-block";
        } else {
            statusDiv.className = "card-panel blue lighten-4";
            statusDiv.textContent = "üìö Showing all analysis reports.";
            startBtn.style.display = "none";
        }
        loadReports();
    }

    // Delete report
    async function deleteReport(reportId) {
        if (!confirm('Delete this report?')) return;
        try {
            const res = await fetch(`/api/analysis/reports/${reportId}`, {
                method: 'DELETE',
                headers: { Authorization: "Bearer " + token }
            });
            const data = await res.json();
            if (data.success) {
                M.toast({ html: 'Report deleted', classes: 'green' });
                loadReports();
            } else {
                M.toast({ html: data.message, classes: 'red' });
            }
        } catch (err) {
            console.error(err);
            M.toast({ html: 'Delete failed', classes: 'red' });
        }
    }

    // Load all reports
    function loadReports() {
        fetch(`/api/analysis/reports`, { headers: { Authorization: "Bearer " + token } })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.items.length) {
                    reportList.innerHTML = "";
                    data.items.forEach(r => {
                        const li = document.createElement("li");
                        li.className = "collection-item";

                        const avgSpeed = (r.avgSpeed || 0).toFixed(2);
                        const maxSpeed = (r.maxSpeed || 0).toFixed(2);
                        const duration = r.duration || 0;
                        const errorDisplay = r.errorRate ? `${r.errorRate.toFixed(1)}cm` : 'N/A';

                        li.innerHTML = `
                            <label>
                                <input type="checkbox" class="report-checkbox" value="${r._id}" />
                                <span></span>
                            </label>
                            <i class="material-icons left">description</i>
                            <span><strong>${r.flightName || "Unnamed Flight"}</strong></span>
                            <div class="report-details">
                                Speed: ${avgSpeed}m/s (avg) | ${maxSpeed}m/s (max)<br>
                                Duration: ${duration}s | Accuracy: ${errorDisplay}
                            </div>
                            <div class="actions">
                                <button class="btn-small red" onclick="deleteReport('${r._id}')">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                        `;
                        reportList.appendChild(li);
                    });
                } else {
                    reportList.innerHTML = "<li class='collection-item'>No reports found.</li>";
                }
            })
            .catch(err => {
                console.error(err);
                reportList.innerHTML = "<li class='collection-item red-text'>Failed to load reports</li>";
            });
    }


    startBtn.addEventListener('click', () => {
        if (!userId || !flightId) {
            M.toast({ html: 'Missing userId or flightId', classes: 'red' });
            return;
        }

        statusDiv.className = "card-panel orange lighten-4";
        statusDiv.textContent = "üîÑ Analysis starting...";
        startBtn.disabled = true;


        socket.emit('startAnalysis', { flightId, userId });
    });


    socket.on('analysisProgress', (data) => {
        statusDiv.className = "card-panel blue lighten-4";
        statusDiv.textContent = data.message;
    });


    socket.on('analysisComplete', (data) => {
        startBtn.disabled = false;
        if (data.success) {
            statusDiv.className = "card-panel green lighten-4";
            statusDiv.textContent = "‚úÖ Analysis complete!";
            M.toast({ html: 'Analysis completed successfully', classes: 'green' });
            loadReports();
        } else {
            statusDiv.className = "card-panel red lighten-4";
            statusDiv.textContent = `‚ùå Error: ${data.message}`;
            M.toast({ html: 'Analysis failed: ' + data.message, classes: 'red' });
        }
    });

    // Start analysis via socket
    exportPdfBtn.addEventListener('click', async () => {
        const selectedIds = Array.from(document.querySelectorAll('.report-checkbox:checked')).map(cb => cb.value);
        if (!selectedIds.length) {
            M.toast({ html: 'Please select at least one report', classes: 'red' });
            return;
        }

        try {

            exportPdfBtn.disabled = true;
            exportPdfBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Generating PDF...';

            const response = await fetch('/api/analysis/reports/pdf', {
                method: 'POST',
                headers: {
                    'Authorization': "Bearer " + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reportIds: selectedIds })
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const blob = await response.blob();
            console.log('Downloaded blob size:', blob.size, 'bytes');
            console.log('Blob type:', blob.type);

            if (blob.size === 0) {
                throw new Error('Downloaded file is empty');
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Flight_Reports_${new Date().toISOString().slice(0,10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

            M.toast({ html: `PDF downloaded (${blob.size} bytes)`, classes: 'green' });

        } catch (err) {
            console.error('PDF download error:', err);
            M.toast({ html: 'Download PDF failed: ' + err.message, classes: 'red' });
        } finally {
            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            exportPdfBtn.disabled = false;
            exportPdfBtn.innerHTML = '<i class="material-icons left">picture_as_pdf</i>Export Selected PDF';
        }
    });
</script>
</body>
</html>
